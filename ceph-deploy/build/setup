#!/bin/bash

# This is the script that runs inside Jenkins.
# http://jenkins.ceph.com/job/ceph-deploy/

set -x
set -e

# ensure dependencies are installed for RPM hosts, because they are required and
# we are not building with a contained environment like we do on DEB builds

# TODO: use Mock to build ceph-deploy rpm's and avoid this

rpm_deps="python-devel python-virtualenv python-mock python-tox pytest"

if test -f /etc/redhat-release ; then
    sudo yum install -y $rpm_deps
fi

# Create the virtualenv
virtualenv $WORKSPACE/venv
source $WORKSPACE/venv/bin/activate

# Define and ensure the PIP cache
PIP_SDIST_INDEX="$HOME/.cache/pip"
mkdir -p $PIP_SDIST_INDEX

CHACRACTL_VERSION="chacractl>=0.0.4"

# Install the package by trying with the cache first, otherwise doing a download only, and then
# trying to install from the cache again.
if ! pip install --upgrade --find-links="file://$PIP_SDIST_INDEX" --no-index $CHACRACTL_VERSION; then
    pip install --upgrade --exists-action=i --download-directory="$PIP_SDIST_INDEX" $CHACRACTL_VERSION
    pip install --upgrade --find-links="file://$PIP_SDIST_INDEX" --no-index $CHACRACTL_VERSION
fi

# create the .chacractl config file
cat > $HOME/.chacractl << EOF
url = "$CHACRACTL_URL"
user = "$CHACRACTL_USER"
key = "$CHACRACTL_KEY"
EOF
