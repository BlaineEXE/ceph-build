#!/bin/bash
# There has to be a better way to do this than this script which just looks
# for every Vagrantfile in scenarios and then just destroys whatever is left.


cd $WORKSPACE/src/ceph-volume/ceph_volume/tests/functional

scenarios=$(find . | grep Vagrantfile | xargs dirname)

mkdir -p $WORKSPACE/logs

pkgs=( "ansible" )
install_python_packages "pkgs[@]"

# in scripts/build_utils.yml
# writes out the playbook that is used to
# collect logs from testing vms
write_collect_logs_playbook

for scenario in $scenarios; do
    cd $scenario
    if [ -f "./vagrant_ssh_config" ]; then
        export ANSIBLE_SSH_ARGS='-F ./vagrant_ssh_config'
        $VENV/ansible-playbook -i hosts --limit osds --extra-vars "archive_path=$WORKSPACE/logs" $WORKSPACE/collect-logs.yml
    fi
    vagrant destroy -f
    cd -
done

# Sometimes, networks may linger around, so we must ensure they are killed:
networks=`sudo virsh net-list --all | grep active | egrep -v "(default|libvirt)" | cut -d ' ' -f 2`
for network in $networks; do
    sudo virsh net-destroy $network || true
    sudo virsh net-undefine $network || true
done

