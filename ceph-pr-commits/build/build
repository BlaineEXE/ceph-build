#!/usr/bin/env python
from subprocess import Popen, PIPE
import os

target_branch = os.getenv('ghprbTargetBranch', 'master')
source_branch = os.getenv('ghprbSourceBranch', 'HEAD')

command = ['git', 'log', '--no-merges', '%s..%s' % (target_branch, source_branch)]


process = Popen(
    command,
    stdout=PIPE,
    stderr=PIPE,
    close_fds=True
)

returncode = process.wait()

stdout = process.stdout.read()
stderr = process.stderr.read()

def extract_sha(lines):
    trim = lines.split()
    for i in trim:
        if i and 'commit' not in i:
            return i

# git log output goes to stdout so process that
for chunk in stdout.split('\n\ncommit'): # we are interested in every commit chunk
    if not chunk:
        continue
    if not 'Signed-off-by:' in chunk:
        sha = extract_sha(chunk)
        raise SystemExit('A commit is missing "Signed-off-by". sha: %s' % sha)
