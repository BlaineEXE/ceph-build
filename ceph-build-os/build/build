#!/bin/bash

set +x

if [ -z $DIST ]; then
    echo "build: No DIST found, exiting !"
    exit 1
fi

if [ -z $DISTRO_RELEASE ]; then
    echo "build: No DISTRO_RELEASE found, exiting !"
    exit 1
fi

if [ -z $VERSION ]; then
    echo "build: No VERSION found, exiting !"
    exit 1
fi

echo "build: Environment is correct"

if [ -z "$REPO_URL" ]; then
    case "$DIST" in
        "xenial"|"trusty")
            REPO_URL="http://ubuntu.mirrors.ovh.net/ubuntu/"
        ;;
        "jessie")
            REPO_URL="http://debian.mirrors.ovh.net/debian/"
        ;;
        "centos")
            REPO_URL="http://centos.mirrors.ovh.net/ftp.centos.org/7/os/x86_64/Packages/centos-release-7-2.1511.el7.centos.2.10.x86_64.rpm"
        ;;
        *)
            echo "build: no known favorite repository for $DIST"
        ;;
    esac
    echo "build: Using repository $REPO_URL"
fi

sudo make ceph-builders DIST=${DIST} DVER=${DISTRO_RELEASE} VERSION=${VERSION} VIRTUALIZED=ceph-builders.virt NO_MGNIDS=True NO_COMPRESSED_FILE=True REPOSITORY=${REPO_URL} KEEP_PKGMNGR=True COMPRESSED=yes && DVER=${DISTRO_RELEASE} VERSION=${VERSION} upload.sh

