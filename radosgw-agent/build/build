#!/bin/bash

set -ex

date
#export GNUPGHOME=/home/jenkins-build/build/gnupg.autobuild/
export GNUPGHOME=/home/jenkins-build/build/gnupg.ceph-release/
export KEYID=17ED316D
HOST=$(hostname --short)
echo "Building on ${HOST}"
echo "  DIST=${DIST}"
echo "  BPTAG=${BPTAG}"
echo "  KEYID=${KEYID}"
echo "  WS=$WORKSPACE"
echo "  PWD=$(pwd)"
ls -l

case $HOST in
*rpm*)
        #cd build
        rm -rf ./dist  # Remove any previous artifacts
        mkdir -p $WORKSPACE/dist/noarch
        mkdir -p $WORKSPACE/dist/SRPMS
        mkdir -p $WORKSPACE/dist/SPECS
        mkdir -p $WORKSPACE/dist/SOURCES
        suse=$(uname -n | grep -ic -e suse -e sles || true)
        if [ $suse -gt 0 ]
        then
            python setup.py clean
            python setup.py bdist_rpm
            if [ $? -eq 0 ]
            then
                mv dist/*.noarch.rpm $WORKSPACE/dist/noarch/.
                mv dist/*.src.rpm $WORKSPACE/dist/SRPMS
            fi
        else
            python setup.py clean
            python setup.py sdist --formats=gztar
            rpmdev-setuptree
            rpmdev-wipetree
            cp -avf ./dist/*.gz $HOME/rpmbuild/SOURCES
            cp -avf radosgw-agent.spec $WORKSPACE/dist/SPECS
            rpmbuild -ba $WORKSPACE/dist/SPECS/radosgw-agent.spec --target noarch
            if [ $? -ne 0 ] ; then
                rm -Rvf $WORKSPACE/dist/${DIST}/
            else
                cp -avf $HOME/rpmbuild/* $WORKSPACE/dist/
            fi
        fi
        ;;
*deb* | tala*)
        #cd build
        DEB_VERSION=$(dpkg-parsechangelog | sed -rne 's,^Version: (.*),\1, p')
        BP_VERSION=${DEB_VERSION}${BPTAG}
        DEBEMAIL="sandon@inktank.com" dch -D $DIST --force-distribution -b -v "$BP_VERSION" "$comment"
        ( cd $WORKSPACE ; dpkg-source -b ./build )  # squeeze uses current directory for tarball
        dpkg-buildpackage -b -k17ED316D
        RC=$?
        if [ $RC -eq 0 ] ; then
            cd $WORKSPACE
            mkdir -p dist
            mv *.changes *.dsc *.deb *.tar.gz dist/.
        fi
        ;;
*)
	echo "Can't determine build host type"
        exit 4
        ;;
esac
