#/bin/bash -ex

echo "BRANCH: $BRANCH"
cd $WORKSPACE/takora

. /etc/os-release

DEBIAN=0

if [[ "$ID" -eq 'Ubuntu' ]] ; then
    DEBIAN=1
fi

if [ $DEBIAN = 1 ] ; then
    dpkg-buildpackage -us -uc
else
    python ./setup.py sdist

    RPMBUILD=$WORKSPACE/rpmbuild
    mkdir -p $RPMBUILD/{SOURCES,SRPMS,SPECS,RPMS,BUILD}
    cp -a dist/takora*.tar.gz  $RPMBUILD/SOURCES/.
    cp -a takora.spec $RPMBUILD/SPECS/.

    cd $RPMBUILD
    rpmbuild -ba --define "_topdir $RPMBUILD" SPECS/takora.spec
fi

cd $WORKSPACE
rm -rf $BRANCH
mkdir $BRANCH

if [ $DEBIAN = 1 ] ; then
    mv *.deb *.dsc *.changes *.tar.gz $BRANCH
else
    find rpmbuild -name '*.rpm' -o -name '*.srpm' | xargs -i mv {} $BRANCH
fi

exit 0
